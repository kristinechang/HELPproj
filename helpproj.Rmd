---
title: "Final Project Assignment #1"
author: "Kristine Chang and Hanna Kim"
date: "Monday, April 19, 2021"
output: pdf_document
---

```{r global_options, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, fig.height=3, fig.width=5, 
                      fig.align = "center")
library(rmarkdown)
library(tidyverse)
library(mosaic)
library(survminer)
library(tidyr)
library(dplyr)
library(survival)
library(broom)
```

#QUESTIONS
#what to do w missing data in the "anysubstatus" column
#do we need to as.factor() abuse type, aka make it categorical? what will that do for us?

#### Load in data set

We load in the data.

```{r}
help <- read_csv("https://pomona.box.com/shared/static/nty3oxpb8db1y763l6uusxtq4gukbcev")
```


#### Exploratory Data Analysis

We made three curves/graphs to explore variables in the data.

```{r}
#survival analysis curve
help_surv <- survfit(Surv(dayslink, linkstatus) ~ 1, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#survival analysis based on gender
help_surv <- survfit(Surv(dayslink, linkstatus) ~ a1, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")
```

```{r}
#does education affect dayslink?
#graph shows the number of years of education plotted against average time to connect to primary care
help %>%
  filter(a9>5) %>%
  group_by(a9) %>%
  summarize(avgdayslink = mean(dayslink,na.rm=TRUE)) %>%
  ggplot() + 
	geom_bar(aes(x = a9, y = avgdayslink), stat="identity") 
```

#### Something New


We will do two topics: investigation of the proportional hazards assumptions using the coxph() function and an analysis of possible time-dependent covariates. The proportional hazards assumptions are needed in survival analysis in order to understand whether hazard ratios vary with time; if the proportional hazards assumption hold, then hazard ratios between groups stay constant over time. On the other hand, time-dependent covariates are covariates that change over time (e.g. stress levels, smoking status, blood pressure) and may affect survival curves. Since we're both interested in both topics, we'll likely work together to understand and implement them. To learn about the proportional hazards assumptions, we'll use the class notes; to learn about both topics, we'll use Youtube videos, math research papers available on Google (we're compiling a doc at https://docs.google.com/document/d/1V1aqCLF6B0XPUkMuXKimcrAGgGZWNOzWSHi0YBvfzYA/edit?usp=sharing with resources), and office hours. Learning about proportional hazards assumptions through coxph() will be challenging because it is a new function in R and we will need to better understand how/why the function works. Learning about time-dependent covariates will be challenging, as we'll need to learn about functions that vary with time, how to implement these covariates in R, and how to interpret them.

#### More EDA

#variables tried (and not interested): age, gender, race, M16, E10B1_R
#variables interested: group (by default), education, anysubstatus, abuse2, alcohol, F1I, E15C2 (maybe)

```{r}
#GROUP

#survival analysis based on group
help_surv <- survfit(Surv(dayslink, linkstatus) ~ group, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether group significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ group, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G0 <- 2*(-683.2197-(-718.0145))
1-pchisq(G0,1)

#group does significantly affect the curve
```

```{r}
#GENDER

#survival analysis based on gender
help_surv <- survfit(Surv(dayslink, linkstatus) ~ a1, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether gender significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ a1, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G1 <- 2*(-716.9893-(-718.0145))
1-pchisq(G1,1)

#gender does not significantly affect the curve
```

```{r}
#AGE

#survival analysis based on age
help_surv <- survfit(Surv(dayslink, linkstatus) ~ age, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether age significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ age, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G2 <- 2*(-716.8824-(-718.0145))
1-pchisq(G2,1)

#age does not significantly affect the curve
```

```{r}
#EDUCATION

#survival analysis based on age
help_surv <- survfit(Surv(dayslink, linkstatus) ~ a9, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether age significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ a9, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G3 <- 2*(-709.6091-(-718.0145))
1-pchisq(G3,1)

#education does significantly affect the curve

help %>%
  filter(a9>5) %>%
  group_by(a9) %>%
  summarize(avgdayslink = mean(dayslink,na.rm=TRUE)) %>%
  ggplot() + 
	geom_line(aes(x = a9, y = avgdayslink), stat="identity") 

#not that many people who have had 16> years education
help %>%
  #filter(a9>16) %>%
  group_by(a9) %>%
  summarize(n())
```

```{r}
#ANYSUBSTATUS

#survival analysis based on substance use
help_surv <- survfit(Surv(dayslink, linkstatus) ~ anysubstatus, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether substance use significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ anysubstatus, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G4 <- 2*(-413.4942-(-718.0145))
1-pchisq(G4,1)

#substance use does significantly affect the curve

#hmm lots of NAs...sus
help %>%
  group_by(anysubstatus) %>%
  summarize(n())
```

```{r}
#abuse2: Type of abuse (0=No abuse, 1=Physical only, 2=Sexual only, 3=Physical and sexual)

help %>%
  group_by(abuse2) %>%
  summarize(n())

help %>%
  group_by(abuse2) %>%
  summarize(avgdayslink = mean(dayslink,na.rm=TRUE)) %>%
  ggplot() + 
	geom_bar(aes(x = abuse2, y = avgdayslink), stat="identity") 

#survival analysis based on abuse type
help_surv <- survfit(Surv(dayslink, linkstatus) ~ as.factor(abuse2), data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether abuse type significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ as.factor(abuse2), data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G5 <- 2*(-708.6925-(-718.0145))
1-pchisq(G5,1)

#type of abuse does significantly affect the curve
```

```{r}
#race: Race (1=Black, 2=White, 3=Hispanic, 4=Other)

help_surv <- survfit(Surv(dayslink, linkstatus) ~ race, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

coxph(Surv(dayslink,linkstatus) ~ race, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G6 <- 2*(-717.5563-(-718.0145	))
1-pchisq(G6,1)

#race is not significant (maybe ask hardin about splitting up races)

help %>%
  group_by(race) %>%
  summarize(n())

#is that a lot of NAs?
```

```{r}
#F1I: I thought my life had been a failure (0=Rarely/never, 1=Some of the time, 2=Ocassionally, 3=Most of the time)

help_surv <- survfit(Surv(dayslink, linkstatus) ~ f1i, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

coxph(Surv(dayslink,linkstatus) ~ f1i, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G7 <- 2*(-716.0107-(-718.0145))
1-pchisq(G7,1)

#F1I is significant (interesting, I thought those who more often thought their life was a failure would take longer to link with primary care) 
```

```{r}
#E15C2: I did not know where to go for help (0=No, 1=Yes)

help_surv <- survfit(Surv(dayslink, linkstatus) ~ e15c2, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

coxph(Surv(dayslink,linkstatus) ~ e15c2, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G8 <- 2*(-107.8898-(-718.0145))
1-pchisq(G8,1)

#E15C2 is significant (way too small of a p-value, pretty sus) 

help %>%
  group_by(e15c2) %>%
  summarize(n())

#seems like there's not that many NAs...or am I trippin
```

```{r}
#M16: Felt guilt/ashamed because of my alcohol drug use (0=No, 1=Yes)

help_surv <- survfit(Surv(dayslink, linkstatus) ~ m16, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

coxph(Surv(dayslink,linkstatus) ~ m16, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G9 <- 2*(-718.0079-(-718.0145))
1-pchisq(G9,1)

#M16 is not significant  

help %>%
  group_by(m16) %>%
  summarize(n())
 
#if I am interpreting this right, there are A TON of NAs in the "yes" group. meaning we should not use this variable
```

```{r}
#E10B1_R: Mental health treatment in the past 6 months (0=No, 1=Yes)

help_surv <- survfit(Surv(dayslink, linkstatus) ~ e10b1_r, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

coxph(Surv(dayslink,linkstatus) ~ e10b1_r, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic
G10 <- 2*(-718.0126-(-718.0145))
1-pchisq(G10,1)

#E10B1_R is not significant  

help %>%
  group_by(e10b1_r) %>%
  summarize(n())

#if I am interpreting this right, there are A TON of NAs in the "no" group. meaning we should not use this variable
```

```{r}
#alcohol: 1st/2nd drug of choice=Alcohol (0=No, 1=Yes)

help %>%
  group_by(alcohol) %>%
  summarize(n())

help %>%
  group_by(alcohol) %>%
  summarize(avgdayslink = mean(dayslink,na.rm=TRUE)) %>%
  ggplot() + 
	geom_bar(aes(x = alcohol, y = avgdayslink), stat="identity") 

#survival analysis based on alcohol
help_surv <- survfit(Surv(dayslink, linkstatus) ~ alcohol, data=help)
ggsurvplot(help_surv, conf.type = "TRUE") +
  ggtitle("HELP data EDA")

#seeing whether abuse type significantly affects the survival curve
coxph(Surv(dayslink,linkstatus) ~ anysubstatus + alcohol, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ alcohol, data = help) %>% glance()
coxph(Surv(dayslink,linkstatus) ~ 1, data = help) %>% glance()

#G-statistic between anysubstatus + alcohol and just alcohol
G5 <- 2*(--411.8382-(-715.9021))
1-pchisq(G5,1)

#alcohol does significantly affect the curve
```
